<!DOCTYPE html>
<meta charset = "UTF-8">
<html>
<head>
	<title>别踩白块儿</title>
</head>

<body>
	<div id="Background">
		<canvas id="GameZone" style="border: solid 1px" onclick="getMousePos()">	
		
		</canvas>
		<p id="Notice">请点击第一个黑块以开始游戏!</p>
		<p id="Score">当前分数：0      最高分数：0</p>
		<button id="restart" disabled ="true" onclick="initialize()">重新开始</button>
		<div id="cover" style="position: absolute; display: none"> <!-- cover作为挡板，在游戏结束后阻止玩家继续点击屏幕 -->
	</div>
	<script>
		function Square(column, top1, black)	//绘图所需的数据及数据改变操作。某些浏览器不支持用class定义类，直接用function写出构造函数
		{
			this.column = column;
			this.top1 = top1;
			this.black = black;		//布尔型的black属性
		}
		
		var width = window.innerWidth;
		var height = window.innerHeight;
		
		function mobile()
		{
			var a = document.getElementById("GameZone").offsetTop;
			if(width >= height)		//在改变canvas的大小和边距、以及修改div的大小和display属性的时候出现了一些问题，以后应该多留意元素的attribute
			{
				document.getElementById("GameZone").setAttribute("height", height * 0.9);
				document.getElementById("GameZone").setAttribute("width", height * 2 * 0.9 / 3);
				document.getElementById("GameZone").style.marginLeft = 0.5 * width - height * 0.9 / 3 + "px";
				document.getElementById("cover").style.height = height * 0.9 + "px";
				document.getElementById("cover").style.width = height * 2 * 0.9 / 3 + "px";
				document.getElementById("cover").style.marginLeft = 0.5 * width - height * 0.9 / 3 + "px";
				document.getElementById("cover").style.top = a + "px";
			}
			else 
			{
				document.getElementById("GameZone").setAttribute("width", width * 0.9);
				document.getElementById("GameZone").setAttribute("height", width * 3 * 0.9 / 2);
				document.getElementById("GameZone").style.marginLeft =  0.05 * width + "px";
				document.getElementById("cover").style.width = width * 0.9 + "px";
				document.getElementById("cover").style.height = width * 3 * 0.9 / 2 + "px";
				document.getElementById("cover").style.marginLeft =  0.05 * width + "px";
				document.getElementById("cover").style.top = a + "px";
			}
			xUnit = document.getElementById("GameZone").offsetWidth/4;
		    yUnit = document.getElementById("GameZone").offsetHeight/4;
		}

		var xUnit;
		var yUnit;
		var SquareArr = [];		//存放块的数组
		var ctx = document.getElementById("GameZone").getContext("2d");
		var intervalID;
		var _1stclkcheck = true;
		var currentScore = 0;
		var hiScore = 0;
		
		function gameProcess()
		{
			intervalID = window.setInterval(draw, 0.05);	//setInterval重绘不会阻塞（？）辣！（
		}
		
		function addNewSquares()	//加入新块
		{
			var column = Math.floor(Math.random () * 4);
			var NewSquare = new Square(column, -yUnit, true);
			SquareArr.push(NewSquare);
		}
		
		function getMousePos(event) 
		{
			if(_1stclkcheck)
			{
				_1stclkcheck = false;
				document.getElementById("Notice").innerHTML = "请注意不要踩到白块哦";
			}
			var e = event || window.event;
			var XCoord = e.offsetX;
			var YCoord = e.offsetY;
			var judge = true;
			for(var i = 0; i < SquareArr.length; i++)
			{
				
				var left1 = (SquareArr[i].column) * xUnit;
				if(XCoord > left1 && XCoord < left1 + xUnit && YCoord > SquareArr[i].top1 && YCoord < SquareArr[i].top1 + yUnit)
				{
					if(SquareArr[i].black)
					{
						SquareArr[i].black = false;
						judge = false;
						currentScore = currentScore + 1;
						if(currentScore >= hiScore)
						{
							hiScore = currentScore;
						}
						document.getElementById("Score").innerHTML = "当前分数：" + currentScore + "      最高分数：" + hiScore;
					}
					else
					{
						document.getElementById("Notice").innerHTML = "踩到白块啦！单击游戏区域以重新开始游戏";
						clearInterval(intervalID);
						judge = false;
						document.getElementById("restart").removeAttribute("disabled");
						document.getElementById("cover").style.display = "block";
					}
				}	
			}
			if(judge)
			{
				document.getElementById("Notice").innerHTML = "踩到白块啦！单击游戏区域以重新开始游戏";
				clearInterval(intervalID);
				document.getElementById("restart").removeAttribute("disabled");
			}
		}
		
		/*判定流程的构想：
			是否踩到了“Square”？-Y->Square的black属性是否为true？-Y->将black改为false，游戏继续
																-N->游戏结束
								-N->游戏结束
		*/
		
		//绘图过程
		function draw()
		{
			ctx.clearRect(0, 0, 4 * xUnit, 4 * yUnit);
			ctx.beginPath();
			ctx.moveTo(xUnit, 0);
			ctx.lineTo(xUnit, 4 * yUnit);
			ctx.moveTo(2 * xUnit, 0);
			ctx.lineTo(2 * xUnit, 4 * yUnit);
			ctx.moveTo(3 * xUnit, 0);
			ctx.lineTo(3 * xUnit, 4 * yUnit);
			ctx.stroke();	
			for(var i = 0; i < SquareArr.length; i++)
			{
				var left1 = (SquareArr[i].column) * xUnit;
				ctx.beginPath();
				if(SquareArr[i].black)
				{
					ctx.fillStyle = "black";
					ctx.fillRect(left1, SquareArr[i].top1, xUnit, yUnit);
					ctx.fill();	
				}
				else 
				{
					ctx.strokeRect(left1, SquareArr[i].top1, xUnit, yUnit);
					ctx.stroke();
				}
			}
			if(!_1stclkcheck)
			{
				if(SquareArr[0].top1 >= 4 * yUnit)	//数组元素的修改。本来想将控制用函数和绘图用函数分离，但是目前没有想到好方法。于是将数组修改的操作放到了一直被调用的绘图函数中。
				{								  	
					SquareArr.shift();
				}
				if(SquareArr.length < 5)
				{
					addNewSquares();
				}
				for(var i = 0; i < SquareArr.length; i++)
				{
					SquareArr[i].top1 = SquareArr[i].top1 + 1;			//改变黑块上边的top坐标
					if(SquareArr[i].top1 >= 4 * yUnit && SquareArr[i].black)
					{
						document.getElementById ("Notice").innerHTML = "黑块漏啦！单击游戏区域以重新开始游戏";
						clearInterval(intervalID);
						document.getElementById("restart").removeAttribute("disabled");
						document.getElementById("cover").style.display = "block";
					}
				}
			}		
		}
	
		//初始化屏幕上一开始就要有的黑块，下标最小的黑块在游戏区域的最下方
		function initialize()
		{
			currentScore = 0;
			SquareArr = [];
			document.getElementById("Notice").innerHTML = "请点击第一个黑块以开始游戏!";
			document.getElementById("restart").setAttribute("disabled", "true");
			_1stclkcheck = true;
			document.getElementById("Score").innerHTML = "当前分数：" + currentScore + "      最高分数：" + hiScore;
			ctx.clearRect(0, 0, 4 * xUnit, 4 * yUnit);
			for(var i = 0; i < 4; i++)
			{
				column = Math.floor(Math.random () * 4);
				SquareArr[i] = new Square(column, (3 - i) * yUnit, true);
			}
			gameProcess();
		}
		
		window.onload = function()
						{
							mobile();
							initialize();
							draw();	
						}
	</script>
</body>

</html>